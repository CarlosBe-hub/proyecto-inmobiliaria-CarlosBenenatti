@model IEnumerable<ProyectoInmobiliaria.Models.Pago>
@{
    ViewData["Title"] = "Pagos";
    var idContrato = ViewBag.Contrato?.IdContrato;
    var totalEsperado = ViewBag.TotalEsperado ?? 0;
    var pagosRealizados = ViewBag.PagosRealizados ?? 0;
    var pagosFaltantes = ViewBag.PagosFaltantes ?? 0;

    bool contratoConcluido = (pagosRealizados >= totalEsperado && totalEsperado > 0);
}

<h2 class="mb-4">Pagos del Contrato @idContrato</h2>

<!-- Mensaje temporal de éxito -->
@if (TempData["SuccessMessage"] != null)
{
    <div id="alertaExito" class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Mensaje temporal de error -->
@if (TempData["ErrorMessage"] != null)
{
    <div id="alertaError" class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<script>
    setTimeout(function () {
        var alertaExito = document.getElementById("alertaExito");
        if (alertaExito) {
            alertaExito.classList.remove("show");
            alertaExito.classList.add("fade");
        }

        var alertaError = document.getElementById("alertaError");
        if (alertaError) {
            alertaError.classList.remove("show");
            alertaError.classList.add("fade");
        }
    }, 3000); // 3 segundos
</script>

<!-- Resumen de pagos -->
<div class="alert alert-info">
    <strong>Total esperado:</strong> @totalEsperado <br />
    <strong>Pagos realizados:</strong> @pagosRealizados <br />
    <strong>Pagos faltantes:</strong> 
    <span class="@(pagosFaltantes > 0 ? "text-danger fw-bold" : "text-success fw-bold")">
        @pagosFaltantes
    </span>
</div>

<!-- Mensaje si el contrato se concretó -->
@if (contratoConcluido)
{
    <div class="alert alert-success">
         El contrato se ha concretado (todos los pagos realizados).
    </div>
}

<div class="mb-3">
    @if (!contratoConcluido)
    {
        <a asp-action="Create" asp-route-idContrato="@idContrato" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Nuevo Pago
        </a>
    }
    <a asp-controller="Contrato" asp-action="Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left-circle"></i> ← Volver a Contratos
    </a>
</div>

<table class="table table-hover table-bordered align-middle">
    <thead class="table-dark">
        <tr>
            <th>N° Pago</th>
            <th>Fecha</th>
            <th>Monto</th>
            <th>Método</th>
            <th>Detalle</th>
            <th>Estado</th>
            <th class="text-center">Acciones</th>
        </tr>
    </thead>
    <tbody>
    @foreach (var item in Model)
    {
        <tr>
            <td>@item.NumeroPago</td>
            <td>@item.FechaPago.ToString("dd/MM/yyyy")</td>
            <td>@item.Monto.ToString("C")</td>
            <td>@item.MetodoPago</td>
            <td>@item.Detalle</td>
            <td>
                @if (item.Anulado)
                {
                    <span class="badge bg-danger">Anulado</span>
                }
                else if (item.Pagado)
                {
                    <span class="badge bg-success">Pagado</span>
                }
                else
                {
                    <span class="badge bg-warning text-dark">Pendiente</span>
                }
            </td>
            <td class="text-center">
                <a asp-action="Details" asp-route-id="@item.IdPago" class="btn btn-info btn-sm text-white">
                    <i class="bi bi-eye"></i> Detalle
                </a>
                <a asp-action="Edit" asp-route-id="@item.IdPago" class="btn btn-warning btn-sm text-dark">
                    <i class="bi bi-pencil-square"></i> Editar
                </a>
                <a asp-action="Delete" asp-route-id="@item.IdPago" class="btn btn-danger btn-sm">
                    <i class="bi bi-x-circle"></i> Anular
                </a>
            </td>
        </tr>
    }
    </tbody>
</table>
